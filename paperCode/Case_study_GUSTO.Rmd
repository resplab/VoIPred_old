---
title: "Case_study_GUSTO"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
load_file=paste0(getwd(),"/../tmp.RDS")

library(knitr)
knitr::opts_chunk$set(echo = TRUE)

load_results <- FALSE  #If true, will not run the simulation, rather will load the results
save_results <- TRUE
```

```{r echo=FALSE, message=FALSE}
source("case_study_GUSTO.R")
print("R code succesfully sourced.\n")
```

The model is 
```{r echo=FALSE} 
settings$master_formula 
```


```{r main, echo=FALSE, message=FALSE, dev='png', fig.show='hide', results=FALSE}
case_study_gusto(load_file=load_file)
```

```{r echo=FALSE}
print(sprintf("Number of simulaitons:%d",settings$n_sim))
```

## Regressoin table (Table 1)
```{r echo=FALSE, message=FALSE}
knitr::kable(results$table_1)
```



## Figures for the case study
## Decision curve
```{r echo=FALSE}
  print("Optimism-corrected (red) NB of the candidate model and its Bayesian estimators (orange: ordinary bootstrap, blue: Bayesian bootstrap), compared with the NB of treating all (black) and treating none (gray)")

  plot(results$res0[,'lambda'],results$res0[,'dc_model']-results$res0[,'optimism'],type='l',   xlab="Threshold", ylab="Net benefit", col="red", lwd=2)
  lines(results$res0[,'lambda'],results$res0[,'dc_all'],type='l',col="black")
  lines(results$res0[,'lambda'],results$res0[,'dc_all']*0,type='l',col="gray")
  lines(results$res0[,'lambda'],results$res0[,'NB_model'],type='l',col="orange" ,lwd=2)
  lines(results$res1[,'lambda'],results$res1[,'NB_model'],type='l',col="blue", lwd=2)
  #lines(tmp[,'lambda'],tmp[,'NB_model'],col="red")
```

### Ordinary bootstrap
```{r echo=FALSE, message=FALSE, results=FALSE}
process_results(results$res0,graphs=c('summit','voi'))
```

### Bayesian bootstrap
```{r echo=FALSE, message=FALSE, results=FALSE}
process_results(results$res1,graphs=c('summit','voi'))
```

##Numerical values of the case study
```{r echo=FALSE, message=FALSE}
print(sprintf("Optimism-corrected AUC:%.4f", results$auc[1]-results$auc[2]))

print(sprintf("Default threshold is: %f",settings$default_th))
  
produce <- function(res)
{
  x <- which(res[,'lambda']==settings$default_th)
  baseline_NB <- max(0,res[x,'NB_all'])
  print(sprintf("Expected NB at default threshold without any model:%.4f",baseline_NB))
  print(sprintf("INB of the proposed model at default threshold:%.4f",res[x,'NB_model']-baseline_NB))
  print(sprintf("INB of the correct model at default threshold:%.4f",res[x,'NB_max']-baseline_NB))
  print(sprintf("voi at default threshold:%.4f",res[x,'voi']))
  voi_r <- (res[x,'NB_max']-max(0,res[x,'NB_all']))/(res[x,'NB_model']-max(0,res[x,'NB_all']))
  print(sprintf("Relative voi at default threshold:%.4f", voi_r))
  
  area_under_inb_current <- mean(res[,'NB_model']-pmax(0,res[,'NB_all']))
  area_under_inb_perfect <- mean(res[,'NB_max']-pmax(0,res[,'NB_all']))
  print(sprintf("Area under INB curve with current information:%.4f", area_under_inb_current))
  print(sprintf("Area under INB curve with perfect information:%.4f", area_under_inb_perfect))
  global_voi_r <- area_under_inb_perfect/area_under_inb_current
  print(sprintf("Global relative voi:%.4f", global_voi_r))
  
  #Monte Carlo errors
  n_sim <- settings$n_sim
  
  
  se_model_all <- sqrt(results$res0[2,'NB_model_all_s2']/n_sim-(results$res0[2,'NB_model']-results$res0[2,'NB_all'])^2/n_sim)
  mu_model_all <- results$res0[2,'NB_model']-results$res0[2,'NB_all']
  distance_model_all <- mu_model_all / se_model_all
  print(sprintf("SE of diff and Monte Carlo sigma differences between NB_model and NB_all:%.6f [%.6f]", se_model_all, distance_model_all))
  
    se_model_max <- sqrt(results$res0[2,'NB_model_max_s2']/n_sim-(results$res0[2,'NB_model']-results$res0[2,'NB_max'])^2/n_sim)
  mu_model_max <- results$res0[2,'NB_model']-results$res0[2,'NB_max']
  distance_model_max <- mu_model_max / se_model_max
  print(sprintf("SE of diff and Monte Carlo sigma differences between NB_model and NB_max:%.6f [%.6f]", se_model_max, distance_model_max))

  
  se_model_0 <- sqrt(results$res0[2,'NB_model_s2']/n_sim-(results$res0[2,'NB_model'])^2/n_sim)
  mu_model_0 <- results$res0[2,'NB_model']
  distance_model_0 <- mu_model_0 / se_model_0
  print(sprintf("SE of diff and Monte Carlo sigma differences between NB_model and 0:%.6f [%.6f]", se_model_0, distance_model_0))
  
  se_all_0 <- sqrt(results$res0[2,'NB_all_s2']/n_sim-(results$res0[2,'NB_all'])^2/n_sim)
  mu_all_0 <- results$res0[2,'NB_all']
  distance_all_0 <- mu_all_0 / se_all_0
  print(sprintf("SE of diff and Monte Carlo sigma differences between NB_all and 0:%.6f [%.6f]", se_all_0, distance_all_0))
  
  se_max_0 <- sqrt(results$res0[2,'NB_max_s2']/n_sim-(results$res0[2,'NB_max'])^2/n_sim)
  mu_max_0 <- results$res0[2,'NB_max']
  distance_max_0 <- mu_max_0 / se_max_0
  print(sprintf("SE of diff and Monte Carlo sigma differences between NB_max and 0:%.6f [%.6f]", se_max_0, distance_max_0))
}

print("Ordinary bootstrap:")
produce(results$res0)
print("Bayesian bootstrap:")
produce(results$res1)
```


### voi by sample size
```{r echo=FALSE}
if(!is.null(results$voi_by_sample_size))
{
  print("voi at index threshold")
  plot(results$voi_by_sample_size[,1:2],type='l', log='x', xlab="Sample size", ylab="EVPI", col='red', lwd=2)
  
  print("voi_r at index threshold")
  plot(results$voi_by_sample_size[,c(1,3)],type='l', log='x', xlab="Sample size", ylab="Relative EVPI", col='red', lwd=2)
}
```

### voi with full data
```{r echo=FALSE}
print(sprintf("voi at index threshold is: %.4f",results$voi_by_sample_size[dim(results$voi_by_sample_size)[1],2]))
print(sprintf("voi_r at index threshold is: %.4f",results$voi_by_sample_size[dim(results$voi_by_sample_size)[1],3]))
